<% layout("/layouts/boilerplate") %>

<!-- Filters Section -->
<div id="filters">
  <a href="/listings" class="filter"><i class="fa-solid fa-fire"></i><p>Trending</p></a>
  <a href="/listings?category=Apartments" class="filter"><i class="fa-solid fa-building"></i><p>Apartments</p></a>
  <a href="/listings?category=Pools" class="filter"><i class="fa-solid fa-person-swimming"></i><p>Pools</p></a>
  <a href="/listings?category=Farm House" class="filter"><i class="fa-solid fa-tractor"></i><p>Farm House</p></a>
  <a href="/listings?category=Villas" class="filter"><img src="./icons/villa.png" alt="villa"><p>Villas</p></a>
  <a href="/listings?category=Cottage" class="filter"><img src="./icons/villa.png" alt="cottage"><p>Cottage</p></a>
  <a href="/listings?category=Mountains" class="filter"><img src="./icons/mountain.png" alt="mountain"><p>Mountains</p></a>
  <a href="/listings?category=Beachfront" class="filter"><img src="./icons/beach.png" alt="beach"><p>Beachfront</p></a>
  <a href="/listings?category=Heritage" class="filter"><img src="./icons/heritage.png" alt="heritage"><p>Heritage</p></a>
  <a href="/listings?category=Resorts" class="filter"><img src="./icons/resorts.png" alt="resorts"><p>Resorts</p></a>
  <a href="/listings?category=Cabins" class="filter"><img src="./icons/villa.png" alt="cabins"><p>Cabins</p></a>
  <a href="/listings?category=Castles" class="filter"><i class="fa-solid fa-castle"></i><p>Castles</p></a>
  <!-- Tax Toggle positioned after Heritage -->
  <div class="tax-toggle">
    <div class="form-check-reverse form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="switchCheckDefault">
      <label class="form-check-label" for="switchCheckDefault">Total after taxes</label>
    </div>
  </div>
</div>

<hr>

<!-- Listings Section -->
<div class="row row-cols-xl-4 row-cols-lg-3 row-cols-md-2 row-cols-sm-1 g-4 mt-3 justify-content-center">
  <% for (let listing of allListings) { %>
    <a href="/listings/<%= listing._id %>" class="listing-link" style="text-decoration: none; color: black;">
      <div class="card listing-card" data-category="<%= listing.category %>">
        <img src="<%= listing.image.url %>" class="card-img-top" alt="listing-image">
        <div class="card-body">
          <div class="info-row"><b>Title:</b><%= listing.title %></div>
          <div class="info-row"><b>Location:</b><%= listing.location %></div>
          <div class="info-row"><b>Country:</b><%= listing.country %></div>
          <div class="info-row"><b>Category:</b> <%= listing.category %></div>
          <div class="info-row"><b>Price:</b>â‚¹<span class="price-value" data-base-price="<%= listing.price %>"><%= listing.price.toLocaleString("en-IN") %></span>/night</div>
        </div>
      </div>
    </a>
  <% } %>
</div>

<script>
  const taxSwitch = document.getElementById("switchCheckDefault");

  function animatePrice(span, from, to) {
    const duration = 400;
    const start = performance.now();

    function update(now) {
      const progress = Math.min((now - start) / duration, 1);
      const current = Math.floor(from + (to - from) * progress);
      span.innerText = current.toLocaleString("en-IN");
      if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
  }

  taxSwitch.addEventListener("change", () => {
    document.querySelectorAll(".price-value").forEach(span => {
      const basePrice = parseFloat(span.getAttribute("data-base-price"));
      const newPrice = taxSwitch.checked ? basePrice * 1.18 : basePrice;
      const currentDisplayed = parseFloat(span.innerText.replace(/,/g, ""));
      animatePrice(span, currentDisplayed, Math.floor(newPrice));
    });
  });

  // Category filtering
  const filters = document.querySelectorAll("#filters .filter");
  const listingLinks = document.querySelectorAll(".listing-link");

  filters.forEach(filter => {
    filter.addEventListener("click", () => {
      const category = filter.querySelector("p").innerText.trim();

      // Remove active class from all filters
      filters.forEach(f => f.classList.remove("active"));
      // Add active class to clicked filter
      filter.classList.add("active");

      // Show/hide listings based on category
      listingLinks.forEach(link => {
        const card = link.querySelector(".listing-card");
        const cardCategory = card.getAttribute("data-category");
        if (category === "Trending" || cardCategory === category) {
          link.style.display = "";
        } else {
          link.style.display = "none";
        }
      });
    });
  });
</script>
